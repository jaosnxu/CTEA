// ============================================================================
// CTEA Platform - Complete Prisma Schema
// ============================================================================
// Architecture: PostgreSQL 14+ with Prisma ORM
// Audit Event: M3.4-GLOBAL-COMP-002A
// Migration Date: 2026-01-12
// Total Tables: 74
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum OrganizationLevel {
  HQ
  ORG
  STORE
}

enum OrganizationStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AdminUserRole {
  HQ_ADMIN
  HQ_OPERATOR
  ORG_ADMIN
  ORG_OPERATOR
  STORE_MANAGER
  STORE_STAFF
}

enum AdminUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_ACTIVATION
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
}

enum OperatorType {
  ADMIN
  USER
  SYSTEM
  API
}

enum ConfigValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
}

enum AccountType {
  DEPOSIT
  REVENUE
  SETTLEMENT
}

enum AccountStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum SettlementCycle {
  DAILY
  WEEKLY
  MONTHLY
}

enum SettlementStatus {
  PENDING
  PROCESSING
  SETTLED
  CANCELLED
}

enum BatchStatus {
  DRAFT
  CONFIRMED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  FAILED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum AddressType {
  HOME
  WORK
  OTHER
}
enum EntityType {
  IP
  PHONE
  DEVICE
  USER
}
enum FenceType {
  CIRCLE
  POLYGON
}
enum MenuType {
  BREAKFAST
  LUNCH
  DINNER
  LATE_NIGHT
  ALL_DAY
}
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
enum ReportType {
  DAILY_SUMMARY
  WEEKLY_REVIEW
  MONTHLY_ANALYSIS
  CUSTOM
}
enum Status {
  NEW
  VIEWED
  ACCEPTED
  REJECTED
  IMPLEMENTED
}
enum SuggestionType {
  PRICING
  INVENTORY
  MARKETING
  OPERATION
}
enum TaskType {
  POST
  VIDEO
  REVIEW
  REFERRAL
}
enum TokenType {
  TOTP
  HARDWARE
}
enum TrustLevel {
  HIGH_RISK
  NORMAL
  TRUSTED
  VIP
}
enum UserType {
  FAN
  INFLUENCER
  STAFF
  ADMIN
}

// ============================================================================
// NEW ENUMS - Full Architecture Implementation
// ============================================================================

/// 组织类型 - 茶饮店 vs 商城
enum OrganizationType {
  TEA_SHOP      // 茶饮店
  SHOPPING_MALL // 商城
}

/// 扩展管理员角色 - RBAC 完整角色
enum ExtendedAdminRole {
  OWNER             // 老板/所有者
  FINANCE_HEAD      // 财务总监
  CASHIER           // 收银员
  ACCOUNTANT        // 会计
  MARKETING         // 市场营销
  STORE_MANAGER     // 店长
  STAFF             // 员工
  AREA_MANAGER      // 区域经理
  OPERATIONS_DIRECTOR // 运营总监
}

/// Banner 类型
enum BannerType {
  IMAGE
  VIDEO
}

/// 营销规则类型
enum MarketingRuleType {
  BOGO              // 买一送一
  FIXED_DISCOUNT    // 固定折扣
  BIRTHDAY_COUPON   // 生日券
  SECOND_HALF_PRICE // 第二杯半价
  FREE_VOUCHER      // 免费券
  PERCENTAGE_OFF    // 百分比折扣
  SPEND_GET         // 满减
}

/// 活动审批状态
enum CampaignApprovalStatus {
  DRAFT             // 草稿
  PENDING_APPROVAL  // 待审批
  APPROVED          // 已批准
  REJECTED          // 已拒绝
  ACTIVE            // 进行中
  EXPIRED           // 已过期
  CANCELLED         // 已取消
}

/// 产品选项类型
enum ProductOptionType {
  SINGLE_CHOICE     // 单选 (冰度、甜度、规格)
  MULTI_CHOICE      // 多选 (加料)
}

/// 积分交易类型
enum PointsTransactionType {
  EARN              // 获得
  REDEEM            // 兑换
  EXPIRE            // 过期
  ADJUST            // 调整
  REFUND            // 退还
}

/// 网红状态
enum InfluencerStatus {
  PENDING           // 待审核
  ACTIVE            // 活跃
  SUSPENDED         // 暂停
  REJECTED          // 拒绝
}

/// 提现状态
enum WithdrawalStatus {
  PENDING           // 待处理
  APPROVED          // 已批准
  PROCESSING        // 处理中
  COMPLETED         // 已完成
  REJECTED          // 已拒绝
}

// ============================================================================
// Models
// ============================================================================
/// 组织表 - 三级架构：总部(HQ) → 组织(ORG) → 门店(STORE)
model Organization {
  id        String              @id @default(uuid())
  parentId  String?
  parent    Organization?       @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children  Organization[]      @relation("OrganizationHierarchy")
  
  code      String              @unique @db.VarChar(50)
  name      Json                // 多语言名称 {ru, zh, en}
  level     OrganizationLevel
  timezone  String              @default("Europe/Moscow") @db.VarChar(50)
  currency  String              @default("RUB") @db.VarChar(10)
  status    OrganizationStatus  @default(ACTIVE)
  config    Json?               // 组织级配置
  
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  createdBy String?
  updatedBy String?
  
  // Relations
  stores              Store[]
  adminUsers          AdminUser[]
  depositAccounts     DepositAccount[]
  settlementRules     SettlementRule[]
  crossStoreLedgers   CrossStoreLedger[]
  settlementBatches   SettlementBatch[]
  systemConfigs       SystemConfig[]
  auditLogs           AuditLog[]
  
  @@index([parentId])
  @@map("organizations")
}

/// 门店表
model Store {
  id              String              @id @default(uuid())
  orgId           String
  organization    Organization        @relation(fields: [orgId], references: [id])
  
  code            String              @db.VarChar(50)
  name            Json                // 多语言名称 {ru, zh, en}
  address         Json?               // 多语言地址 {ru, zh, en}
  phone           String?             @db.VarChar(20)
  email           String?             @db.VarChar(255)
  timezone        String              @default("Europe/Moscow") @db.VarChar(50)
  latitude        Decimal?            @db.Decimal(10, 7)
  longitude       Decimal?            @db.Decimal(10, 7)
  businessHours   Json?               // 营业时间配置
  cutoffHour      Int                 @default(5)
  iikoTerminalId  String?             @db.VarChar(100)
  status          OrganizationStatus  @default(ACTIVE)
  config          Json?               // 门店级配置
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       String?
  updatedBy       String?
  
    // Relations
    adminUsers            AdminUser[]
    depositAccounts       DepositAccount[]
    crossStoreLedgersIssue CrossStoreLedger[] @relation("IssueStore")
    crossStoreLedgersRedeem CrossStoreLedger[] @relation("RedeemStore")
    systemConfigs         SystemConfig[]
    orders                Orders[]
  
    @@unique([orgId, code])
  @@index([orgId])
  @@map("stores")
}

/// 管理员用户表
model AdminUser {
  id              String            @id @default(uuid())
  orgId           String?
  organization    Organization?     @relation(fields: [orgId], references: [id])
  storeId         String?
  store           Store?            @relation(fields: [storeId], references: [id])
  
  username        String            @unique @db.VarChar(50)
  passwordHash    String            @db.VarChar(255)
  phone           String?           @db.VarChar(20)
  phoneVerified   Boolean           @default(false)
  email           String?           @db.VarChar(255)
  name            Json?             // 多语言名称 {ru, zh, en}
  role            AdminUserRole
  permissions     Json?             // 权限列表
  languagePref    String            @default("ru") @db.VarChar(10)
  status          AdminUserStatus   @default(PENDING_ACTIVATION)
  lastLoginAt     DateTime?
  lastLoginIp     String?           @db.VarChar(45)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@index([orgId])
  @@index([storeId])
  @@map("admin_users")
}

/// 审计日志表 - Diff Log（不可篡改）+ SHA-256 链式审计
model AuditLog {
  id            BigInt          @id @default(autoincrement())
  orgId         String?
  organization  Organization?   @relation(fields: [orgId], references: [id])
  
  tableName     String          @db.VarChar(100)
  recordId      String          @db.VarChar(100)
  action        AuditAction
  diffBefore    Json?           // 修改前数据
  diffAfter     Json?           // 修改后数据
  operatorId    String?
  operatorType  OperatorType?
  operatorName  String?         @db.VarChar(100)
  ipAddress     String?         @db.VarChar(45)
  userAgent     String?
  reason        String?
  
  // SHA-256 链式审计字段（M3.4-GLOBAL-COMP-002 要求）
  eventId       String?         @unique @db.VarChar(100)
  previousHash  String?         @db.VarChar(64)
  sha256Hash    String?         @db.VarChar(64)
  
  createdAt     DateTime        @default(now())
  
  @@index([orgId])
  @@index([tableName])
  @@index([tableName, recordId])
  @@index([createdAt])
  @@index([eventId])
  @@map("audit_logs")
}

/// 系统配置表 - 参数化配置（严禁 Hardcode）
model SystemConfig {
  id            String          @id @default(uuid())
  orgId         String?
  organization  Organization?   @relation(fields: [orgId], references: [id])
  storeId       String?
  store         Store?          @relation(fields: [storeId], references: [id])
  
  configKey     String          @db.VarChar(100)
  configValue   Json
  valueType     ConfigValueType
  description   Json?           // 多语言描述 {ru, zh, en}
  isEditable    Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@unique([orgId, storeId, configKey])
  @@map("system_configs")
}

/// 权限规则表
model PermissionRule {
  id          String    @id @default(uuid())
  role        String    @db.VarChar(50)
  resource    String    @db.VarChar(100)
  action      String    @db.VarChar(50)
  conditions  Json?     // 条件表达式
  isAllowed   Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@index([resource])
  @@map("permission_rules")
}

// ============================================================================
// 第二章：财务模块 (Finance)
// ============================================================================

/// 虚拟保证金账户表
model DepositAccount {
  id            String          @id @default(uuid())
  orgId         String
  organization  Organization    @relation(fields: [orgId], references: [id])
  storeId       String
  store         Store           @relation(fields: [storeId], references: [id])
  
  accountType   AccountType     @default(DEPOSIT)
  balance       Decimal         @default(0.00) @db.Decimal(15, 2)
  frozenAmount  Decimal         @default(0.00) @db.Decimal(15, 2)
  currency      String          @default("RUB") @db.VarChar(10)
  status        AccountStatus   @default(ACTIVE)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@unique([storeId, accountType])
  @@index([orgId])
  @@map("deposit_accounts")
}

/// 结算规则表
model SettlementRule {
  id                    String            @id @default(uuid())
  orgId                 String?
  organization          Organization?     @relation(fields: [orgId], references: [id])
  
  ruleCode              String            @db.VarChar(50)
  name                  Json              // 多语言名称
  delayDays             Int               @default(7)
  autoRefundThreshold   Decimal           @default(0.30) @db.Decimal(5, 2)
  settlementCycle       SettlementCycle   @default(WEEKLY)
  isActive              Boolean           @default(true)
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  createdBy             String?
  updatedBy             String?
  
  @@map("settlement_rules")
}

/// 跨店对账表 - A店发券B店核销
model CrossStoreLedger {
  id                BigInt            @id @default(autoincrement())
  orgId             String
  organization      Organization      @relation(fields: [orgId], references: [id])
  orderId           BigInt
  couponId          String
  userCouponId      String
  issueStoreId      String
  issueStore        Store             @relation("IssueStore", fields: [issueStoreId], references: [id])
  redeemStoreId     String
  redeemStore       Store             @relation("RedeemStore", fields: [redeemStoreId], references: [id])
  
  amount            Decimal           @db.Decimal(15, 2)
  settlementStatus  SettlementStatus  @default(PENDING)
  settlementBatchId String?
  settlementBatch   SettlementBatch?  @relation(fields: [settlementBatchId], references: [id])
  settledAt         DateTime?
  businessDate      String?           @db.VarChar(10)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@index([orgId])
  @@index([orderId])
  @@index([issueStoreId])
  @@index([redeemStoreId])
  @@index([settlementStatus])
  @@map("cross_store_ledger")
}

/// 结算批次表
model SettlementBatch {
  id            String              @id @default(uuid())
  orgId         String
  organization  Organization        @relation(fields: [orgId], references: [id])
  
  batchNo       String              @unique @db.VarChar(50)
  periodStart   DateTime
  periodEnd     DateTime
  totalAmount   Decimal             @default(0.00) @db.Decimal(15, 2)
  netAmount     Decimal             @default(0.00) @db.Decimal(15, 2)
  recordCount   Int                 @default(0)
  status        BatchStatus         @default(DRAFT)
  confirmedBy   String?
  confirmedAt   DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  // Relations
  crossStoreLedgers CrossStoreLedger[]
  
  @@map("settlement_batches")
}

/// 退款记录表
model RefundRecord {
  id              String        @id @default(uuid())
  orderId         String
  userId          String
  amount          Decimal       @db.Decimal(15, 2)
  reason          String?
  status          RefundStatus  @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  refundMethod    String?       @db.VarChar(50)
  refundReference String?       @db.VarChar(100)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("refund_records")
}

/// 财务报表表
model FinancialReport {
  id            String    @id @default(uuid())
  reportType    String    @db.VarChar(50)
  periodStart   DateTime
  periodEnd     DateTime
  reportData    Json      // 报表数据
  generatedBy   String?
  generatedAt   DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  
  @@index([reportType])
  @@index([periodStart, periodEnd])
  @@map("financial_reports")
}


// ============================================================================
// Auto-generated Models (Remaining 62 tables)
// ============================================================================


/// Campaigns
model Campaigns {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  code                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("campaigns")
}
/// Coupons
model Coupons {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  campaignId           Int?
  code                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("coupons")
}
/// Usercoupons
model Usercoupons {
  id                   String @id @default(uuid())
  userId               Int
  couponId             Int
  issueStoreId         Int
  couponCode           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("user_coupons")
}
/// Sduilayouts
model Sduilayouts {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  layoutCode           String?
  layoutConfig         String?  @db.Text
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("sdui_layouts")
}
/// Geofencerules
model Geofencerules {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  name                 Json
  fenceType            FenceType
  centerLat            Decimal? @db.Decimal(10, 7)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("geo_fence_rules")
}
/// Weathertriggers
model Weathertriggers {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  name                 Json
  weatherCondition     Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("weather_triggers")
}
/// Categories
model Categories {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  parentId             Int?
  code                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("categories")
}
/// Products
model Products {
  id                   Int @id @default(autoincrement())
  orgId                String?   @db.VarChar(36)
  categoryId           Int
  code                 String?  @db.VarChar(50)
  name                 Json?
  description          Json?
  image                String?  @db.VarChar(500)
  images               Json?
  basePrice            Decimal? @db.Decimal(15, 2)
  iikoProductId        String?  @db.VarChar(100)
  iikoGroupId          String?  @db.VarChar(100)
  nutritionInfo        Json?
  allergens            Json?
  preparationTime      Int?
  isActive             Boolean? @default(true)
  sortOrder            Int?     @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  orderItems           Orderitems[]
  
  @@map("products")
}
/// PricingRules
model PricingRules {
  id                   String @id @default(uuid())
  productId            String?
  name                 String   @db.VarChar(200)
  description          String?  @db.Text
  condition            Json
  action               Json
  priority             Int      @default(0)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("pricing_rules")
}
/// Skuattributes
model Skuattributes {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  attributeCode        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("sku_attributes")
}
/// Productskus
model Productskus {
  id                   String @id @default(uuid())
  productId            Int
  skuCode              String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("product_skus")
}
/// Storeprices
model Storeprices {
  id                   String @id @default(uuid())
  storeId              Int
  productId            Int
  price                Decimal? @db.Decimal(15, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("store_prices")
}
/// Timeslotmenus
model Timeslotmenus {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  storeId              Int?
  name                 Json
  menuType             MenuType
  startTime            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("time_slot_menus")
}
/// Iikoshadowmenu
model Iikoshadowmenu {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  productId            Int
  iikoProductId        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("iiko_shadow_menu")
}
/// Pricechangelogs
model Pricechangelogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("price_change_logs")
}
/// Datapipelines
model Datapipelines {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  pipelineCode         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("data_pipelines")
}
/// Aireports
model Aireports {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  storeId              Int?
  reportType           ReportType
  reportDate           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("ai_reports")
}
/// Translationreviews
model Translationreviews {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  sourceType           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("translation_reviews")
}
/// Aisuggestions
model Aisuggestions {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  storeId              Int?
  suggestionType       SuggestionType
  title                Json
  content              Json
  priority             Priority? @default(MEDIUM)
  status               Status? @default(NEW)
  actionedBy           Int?
  actionedAt           DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("ai_suggestions")
}
/// Vectorembeddings
model Vectorembeddings {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("vector_embeddings")
}
/// Llmcalllogs
model Llmcalllogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("llm_call_logs")
}
/// Orders
model Orders {
  id                   BigInt @id @default(autoincrement())
  orderNumber          String?  @db.VarChar(50)
  storeId              String?
  store                Store?   @relation(fields: [storeId], references: [id])
  userId               String?
  user                 Users?   @relation(fields: [userId], references: [id])
  status               OrderStatus @default(PENDING)
  totalAmount          Decimal? @db.Decimal(15, 2)
  subtotalAmount       Decimal? @db.Decimal(15, 2)
  discountAmount       Decimal? @db.Decimal(15, 2) @default(0.00)
  taxAmount            Decimal? @db.Decimal(15, 2) @default(0.00)
  deliveryFee          Decimal? @db.Decimal(15, 2) @default(0.00)
  notes                String?  @db.Text
  deliveryAddress      Json?
  paymentMethod        String?  @db.VarChar(50)
  paymentStatus        String?  @db.VarChar(50)
  deletedAt            DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  
  orderItems           Orderitems[]
  
  @@index([storeId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("orders")
}
/// Orderitems
model Orderitems {
  id                   BigInt @id @default(autoincrement())
  orderId              BigInt?
  order                Orders?  @relation(fields: [orderId], references: [id])
  productId            Int?
  product              Products? @relation(fields: [productId], references: [id])
  productName          String?  @db.VarChar(200)
  productCode          String?  @db.VarChar(100)
  quantity             Int      @default(1)
  unitPrice            Decimal  @db.Decimal(15, 2)
  subtotal             Decimal  @db.Decimal(15, 2)
  discountAmount       Decimal? @db.Decimal(15, 2) @default(0.00)
  specifications       Json?
  notes                String?  @db.Text
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}
/// Orderdiscounts
model Orderdiscounts {
  id                   String @id @default(uuid())
  orderId              BigInt?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("order_discounts")
}
/// Reviews
model Reviews {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  storeId              Int
  orderId              BigInt?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("reviews")
}
/// Reviewimages
model Reviewimages {
  id                   String @id @default(uuid())
  reviewId             Int
  imageUrl             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("review_images")
}
/// Mallproducts
model Mallproducts {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  categoryId           Int?
  code                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("mall_products")
}
/// Mallorders
model Mallorders {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("mall_orders")
}
/// Mallorderitems
model Mallorderitems {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("mall_order_items")
}
/// Mallinventory
model Mallinventory {
  id                   String @id @default(uuid())
  productId            Int
  warehouseId          Int?
  quantity             Int? @default(0)
  reservedQuantity     Int? @default(0)
  lowStockThreshold    Int? @default(10)
  updatedAt            DateTime @default(now()) @updatedAt
  createdAt            DateTime @default(now())
  createdBy            String?
  updatedBy            String?
  @@map("mall_inventory")
}
/// Logisticstracking
model Logisticstracking {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("logistics_tracking")
}
/// Influencers
model Influencers {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  userId               Int
  code                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("influencers")
}
/// Influencertasks
model Influencertasks {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  name                 Json
  description          Json?
  taskType             TaskType
  requirements         Json?
  reward               Decimal? @db.Decimal(15, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("influencer_tasks")
}
/// Tasksubmissions
model Tasksubmissions {
  id                   String @id @default(uuid())
  taskId               Int
  influencerId         Int
  submissionUrl        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("task_submissions")
}
/// Influencercommissions
model Influencercommissions {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("influencer_commissions")
}
/// Withdrawalrequests
model Withdrawalrequests {
  id                   String @id @default(uuid())
  influencerId         Int
  amount               Decimal? @db.Decimal(15, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("withdrawal_requests")
}
/// Referrallinks
model Referrallinks {
  id                   String @id @default(uuid())
  influencerId         Int
  linkCode             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("referral_links")
}
/// Chatsessions
model Chatsessions {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("chat_sessions")
}
/// Chatmessages
model Chatmessages {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("chat_messages")
}
/// Aiintents
model Aiintents {
  id                   String @id @default(uuid())
  intentCode           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("ai_intents")
}
/// Quickreplies
model Quickreplies {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  category             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("quick_replies")
}
/// Faqentries
model Faqentries {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  category             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("faq_entries")
}
/// Telegrambotconfig
model Telegrambotconfig {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  botToken             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("telegram_bot_config")
}
/// Users
model Users {
  id                   String @id @default(uuid())
  openId               String?
  phone                String?  @db.VarChar(20)
  nickname             String?  @db.VarChar(100)
  avatar               String?  @db.VarChar(500)
  status               String?  @default("ACTIVE") @db.VarChar(20)
  level                String?  @db.VarChar(20)
  lastLoginAt          DateTime? @map("last_login_at")
  lastLoginIp          String?  @db.VarChar(50) @map("last_login_ip")
  loginCount           Int?     @default(0) @map("login_count")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  
  orders               Orders[]
  
  @@map("users")
}
/// Useraddresses
model Useraddresses {
  id                   String @id @default(uuid())
  userId               Int
  addressType          AddressType? @default(HOME)
  recipientName        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("user_addresses")
}
/// Userpoints
model Userpoints {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("user_points")
}
/// Giftcards
model Giftcards {
  id                   String @id @default(uuid())
  orgId                String?   @db.VarChar(36)
  cardCode             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("gift_cards")
}
/// Smsproviders
model Smsproviders {
  id                   String @id @default(uuid())
  providerCode         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("sms_providers")
}
/// Smsverificationlogs
model Smsverificationlogs {
  id                   BigInt @id @default(autoincrement())
  phone                String @db.VarChar(20)
  verificationCode     String @db.VarChar(10) @map("verification_code")
  purpose              String @db.VarChar(50)
  provider             String? @db.VarChar(50)
  status               String @default("SENT") @db.VarChar(20)
  expiresAt            DateTime @map("expires_at")
  attempts             Int @default(0)
  verifiedAt           DateTime? @map("verified_at")
  ipAddress            String? @db.VarChar(50) @map("ip_address")
  userAgent            String? @db.VarChar(500) @map("user_agent")
  geoCountry           String? @db.VarChar(50) @map("geo_country")
  geoCity              String? @db.VarChar(100) @map("geo_city")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  createdBy            String? @map("created_by")
  updatedBy            String? @map("updated_by")
  
  @@index([phone, purpose, status])
  @@index([expiresAt])
  @@map("sms_verification_logs")
}
/// Phonebindings
model Phonebindings {
  id                   String @id @default(uuid())
  userId               Int
  userType             UserType
  phone                String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("phone_bindings")
}
/// Sensitiveactionlogs
model Sensitiveactionlogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("sensitive_action_logs")
}
/// Securitytokens
model Securitytokens {
  id                   String @id @default(uuid())
  adminUserId          Int
  tokenType            TokenType
  secretKey            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("security_tokens")
}
/// Verificationrules
model Verificationrules {
  id                   String @id @default(uuid())
  ruleCode             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("verification_rules")
}
/// Riskcontrollogs
model Riskcontrollogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("risk_control_logs")
}
/// Captchaconfigs
model Captchaconfigs {
  id                   String @id @default(uuid())
  provider             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("captcha_configs")
}
/// Captchaverifylogs
model Captchaverifylogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("captcha_verify_logs")
}
/// Securityrules
model Securityrules {
  id                   String @id @default(uuid())
  ruleCode             String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("security_rules")
}
/// Securityauditlogs
model Securityauditlogs {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("security_audit_logs")
}
/// Blockedentities
model Blockedentities {
  id                   String @id @default(uuid())
  entityType           EntityType
  entityValue          String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("blocked_entities")
}
/// Translations
model Translations {
  id                   String @id @default(uuid())
  key                  String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("translations")
}
/// Translationauditlog
model Translationauditlog {
  id                   String @id @default(uuid())
  translationId        Int
  action               String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("translation_audit_log")
}
/// Offlineredemptionqueue
model Offlineredemptionqueue {
  id                   BigInt @id @default(autoincrement())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("offline_redemption_queue")
}
/// Usertrustscores
model Usertrustscores {
  id                   String @id @default(uuid())
  userId               Int
  trustScore           Int? @default(0)
  trustLevel           TrustLevel? @default(NORMAL)
  registrationDays     Int? @default(0)
  totalOrders          Int? @default(0)
  totalSpent           Decimal? @db.Decimal(15, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdBy            String?
  updatedBy            String?
  @@map("user_trust_scores")
}

// ============================================================================
// System Health Check Table - For connectivity verification
// ============================================================================
/// 系统健康检查表 - 用于验证全链路连通性
model SystemCheck {
  id          String   @id @default(uuid())
  checkKey    String   @unique @db.VarChar(100)
  checkValue  String   @db.Text
  description Json?    // 多语言描述 {ru, zh, en}
  lastChecked DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("system_check")
}

// ============================================================================
// NEW MODELS - Full Architecture Implementation
// ============================================================================

/// 用户偏好设置 - 语言持久化
model UserPreference {
  id            String   @id @default(uuid())
  userId        String   @unique
  languageCode  String   @default("ru") @db.VarChar(10) // ru, zh, en
  timezone      String   @default("Europe/Moscow") @db.VarChar(50)
  notifications Json?    // 通知偏好设置
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("user_preferences")
}

/// Banner 轮播图 - 动态配置
model Banner {
  id            String      @id @default(uuid())
  orgId         String
  storeId       String?     // null = 全组织
  
  title         Json        // 多语言标题 {ru, zh, en}
  mediaType     BannerType  @default(IMAGE)
  mediaUrl      String      @db.VarChar(500)
  linkUrl       String?     @db.VarChar(500)
  linkType      String?     @db.VarChar(50) // internal, external, product, category
  linkTarget    String?     @db.VarChar(100) // 目标ID或URL
  
  displayOrder  Int         @default(0)
  isActive      Boolean     @default(true)
  startTime     DateTime?
  endTime       DateTime?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@index([orgId])
  @@index([storeId])
  @@index([isActive, startTime, endTime])
  @@map("banners")
}

/// 营销规则 - 规则引擎
model MarketingRule {
  id            String              @id @default(uuid())
  orgId         String
  storeId       String?             // null = 全组织
  
  name          Json                // 多语言名称 {ru, zh, en}
  description   Json?               // 多语言描述
  ruleType      MarketingRuleType
  ruleConfig    Json                // 规则配置 (折扣值、条件等)
  
  priority      Int                 @default(0)
  isStackable   Boolean             @default(false) // 是否可叠加
  maxUsageTotal Int?                // 总使用次数限制
  maxUsagePerUser Int?              // 每用户使用次数限制
  currentUsage  Int                 @default(0)
  
  applicableProducts Json?          // 适用产品ID列表
  applicableCategories Json?        // 适用分类ID列表
  excludedProducts Json?            // 排除产品ID列表
  
  minOrderAmount Decimal?           @db.Decimal(15, 2)
  
  startTime     DateTime?
  endTime       DateTime?
  isActive      Boolean             @default(true)
  
  approvalStatus CampaignApprovalStatus @default(DRAFT)
  approvedBy    String?
  approvedAt    DateTime?
  rejectionReason String?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@index([orgId])
  @@index([ruleType])
  @@index([isActive, startTime, endTime])
  @@index([approvalStatus])
  @@map("marketing_rules")
}

/// 产品选项组 - 单选/多选配置
model ProductOptionGroup {
  id            String              @id @default(uuid())
  orgId         String
  
  name          Json                // 多语言名称 {ru, zh, en} (冰度、甜度、规格、加料)
  code          String              @db.VarChar(50) // ICE, SWEETNESS, SIZE, TOPPING
  optionType    ProductOptionType
  
  isRequired    Boolean             @default(false)
  minSelect     Int                 @default(0)
  maxSelect     Int                 @default(1)
  displayOrder  Int                 @default(0)
  isActive      Boolean             @default(true)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  options       ProductOptionItem[]
  productOptions ProductOptionMapping[]
  
  @@unique([orgId, code])
  @@index([orgId])
  @@map("product_option_groups")
}

/// 产品选项项 - 选项值
model ProductOptionItem {
  id            String              @id @default(uuid())
  groupId       String
  group         ProductOptionGroup  @relation(fields: [groupId], references: [id])
  
  name          Json                // 多语言名称 {ru, zh, en} (正常冰、少冰、去冰)
  code          String              @db.VarChar(50)
  priceAdjust   Decimal             @default(0) @db.Decimal(15, 2) // 价格调整
  
  displayOrder  Int                 @default(0)
  isDefault     Boolean             @default(false)
  isActive      Boolean             @default(true)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@index([groupId])
  @@map("product_option_items")
}

/// 产品-选项组映射
model ProductOptionMapping {
  id            String              @id @default(uuid())
  productId     String
  optionGroupId String
  optionGroup   ProductOptionGroup  @relation(fields: [optionGroupId], references: [id])
  
  isRequired    Boolean             @default(false)
  displayOrder  Int                 @default(0)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  @@unique([productId, optionGroupId])
  @@index([productId])
  @@map("product_option_mappings")
}

/// 积分账户
model PointsAccount {
  id            String              @id @default(uuid())
  userId        String
  orgId         String
  
  balance       Int                 @default(0)
  totalEarned   Int                 @default(0)
  totalRedeemed Int                 @default(0)
  totalExpired  Int                 @default(0)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  transactions  PointsTransaction[]
  
  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
  @@map("points_accounts")
}

/// 积分交易记录
model PointsTransaction {
  id            String                  @id @default(uuid())
  accountId     String
  account       PointsAccount           @relation(fields: [accountId], references: [id])
  
  type          PointsTransactionType
  amount        Int                     // 正数=获得，负数=消耗
  balance       Int                     // 交易后余额
  
  orderId       String?                 // 关联订单
  ruleId        String?                 // 关联规则
  description   Json?                   // 多语言描述
  
  expiresAt     DateTime?               // 过期时间
  
  createdAt     DateTime                @default(now())
  createdBy     String?
  
  @@index([accountId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
  @@map("points_transactions")
}

/// 积分规则
model PointsRule {
  id            String              @id @default(uuid())
  orgId         String
  
  name          Json                // 多语言名称
  description   Json?               // 多语言描述
  
  earnRate      Decimal             @default(1) @db.Decimal(10, 4) // 消费1元=X积分
  redeemRate    Decimal             @default(100) @db.Decimal(10, 4) // X积分=1元
  
  minEarnAmount Decimal?            @db.Decimal(15, 2) // 最低消费金额才能获得积分
  maxRedeemPercent Int              @default(100) // 最大抵扣比例
  
  excludeDiscounted Boolean         @default(true) // 折扣商品不获得积分
  excludeCategories Json?           // 排除的分类
  excludeProducts Json?             // 排除的产品
  
  expiryDays    Int?                // 积分有效期(天)
  
  isActive      Boolean             @default(true)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@index([orgId])
  @@map("points_rules")
}

/// 网红详情增强
model InfluencerProfile {
  id            String              @id @default(uuid())
  userId        String              @unique
  orgId         String
  storeId       String?             // 绑定门店
  
  displayName   Json                // 多语言显示名
  bio           Json?               // 多语言简介
  avatarUrl     String?             @db.VarChar(500)
  
  trackingCode  String              @unique @db.VarChar(50) // 追踪码
  trackingUrl   String?             @db.VarChar(500) // 完整追踪链接
  
  status        InfluencerStatus    @default(PENDING)
  
  totalOrders   Int                 @default(0)
  totalRevenue  Decimal             @default(0) @db.Decimal(15, 2)
  totalCommission Decimal           @default(0) @db.Decimal(15, 2)
  pendingCommission Decimal         @default(0) @db.Decimal(15, 2)
  
  commissionRate Decimal            @default(0.05) @db.Decimal(5, 4) // 佣金比例
  
  ranking       Int?                // 排名
  rankingUpdatedAt DateTime?
  
  socialLinks   Json?               // 社交媒体链接
  
  approvedBy    String?
  approvedAt    DateTime?
  rejectionReason String?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  withdrawals   InfluencerWithdrawal[]
  
  @@index([orgId])
  @@index([storeId])
  @@index([trackingCode])
  @@index([status])
  @@index([ranking])
  @@map("influencer_profiles")
}

/// 网红提现记录
model InfluencerWithdrawal {
  id            String              @id @default(uuid())
  influencerId  String
  influencer    InfluencerProfile   @relation(fields: [influencerId], references: [id])
  
  amount        Decimal             @db.Decimal(15, 2)
  status        WithdrawalStatus    @default(PENDING)
  
  bankInfo      Json?               // 银行信息
  paymentMethod String?             @db.VarChar(50)
  transactionId String?             @db.VarChar(100)
  
  processedBy   String?
  processedAt   DateTime?
  rejectionReason String?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  @@index([influencerId])
  @@index([status])
  @@map("influencer_withdrawals")
}

/// LLM 配置 - AI API Key 管理
model LLMConfig {
  id            String              @id @default(uuid())
  orgId         String
  
  provider      String              @db.VarChar(50) // openai, deepseek, claude
  name          String              @db.VarChar(100)
  apiKey        String              @db.VarChar(500) // 加密存储
  apiEndpoint   String?             @db.VarChar(500)
  
  modelName     String?             @db.VarChar(100)
  maxTokens     Int?
  temperature   Decimal?            @db.Decimal(3, 2)
  
  isDefault     Boolean             @default(false)
  isActive      Boolean             @default(true)
  
  usageCount    Int                 @default(0)
  lastUsedAt    DateTime?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@index([orgId])
  @@index([provider])
  @@map("llm_configs")
}

/// IIKO 集成配置
model IIKOConfig {
  id            String              @id @default(uuid())
  orgId         String              @unique
  
  apiKey        String              @db.VarChar(500) // 加密存储
  apiEndpoint   String?             @db.VarChar(500)
  organizationId String?            @db.VarChar(100)
  
  syncEnabled   Boolean             @default(true)
  lastSyncAt    DateTime?
  syncStatus    String?             @db.VarChar(50)
  syncError     String?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@map("iiko_configs")
}

/// 分类增强 - 动态排序和显示
model CategoryEnhanced {
  id            String              @id @default(uuid())
  orgId         String
  parentId      String?
  
  name          Json                // 多语言名称 {ru, zh, en}
  description   Json?               // 多语言描述
  icon          String?             @db.VarChar(100)
  imageUrl      String?             @db.VarChar(500)
  
  displayOrder  Int                 @default(0)
  isVisible     Boolean             @default(true)
  isActive      Boolean             @default(true)
  
  // 时间控制
  visibleStartTime DateTime?
  visibleEndTime DateTime?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  products      ProductEnhanced[]
  
  @@index([orgId])
  @@index([parentId])
  @@index([displayOrder])
  @@map("categories_enhanced")
}

/// 产品增强 - 完整动态配置
model ProductEnhanced {
  id            String              @id @default(uuid())
  orgId         String
  categoryId    String
  category      CategoryEnhanced    @relation(fields: [categoryId], references: [id])
  
  code          String              @db.VarChar(50)
  name          Json                // 多语言名称 {ru, zh, en}
  description   Json?               // 多语言描述
  
  basePrice     Decimal             @db.Decimal(15, 2)
  currency      String              @default("RUB") @db.VarChar(10)
  
  images        Json?               // 图片URL列表
  thumbnailUrl  String?             @db.VarChar(500)
  
  // 库存
  stockQuantity Int?
  lowStockThreshold Int?            @default(10)
  trackStock    Boolean             @default(false)
  
  // 显示控制
  displayOrder  Int                 @default(0)
  isVisible     Boolean             @default(true)
  isActive      Boolean             @default(true)
  isFeatured    Boolean             @default(false)
  isNew         Boolean             @default(false)
  
  // 时间控制
  availableStartTime DateTime?
  availableEndTime DateTime?
  
  // 限购
  maxPerOrder   Int?
  maxPerUser    Int?
  
  // 标签
  tags          Json?               // 标签列表
  
  // IIKO 同步
  iikoProductId String?             @db.VarChar(100)
  isManualOverride Boolean          @default(false) // Shadow DB 保护
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@unique([orgId, code])
  @@index([orgId])
  @@index([categoryId])
  @@index([displayOrder])
  @@index([isActive, isVisible])
  @@map("products_enhanced")
}

/// 权限定义
model Permission {
  id            String              @id @default(uuid())
  
  code          String              @unique @db.VarChar(100)
  name          Json                // 多语言名称
  description   Json?               // 多语言描述
  module        String              @db.VarChar(50) // 模块: product, order, finance, marketing, etc.
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  rolePermissions RolePermission[]
  
  @@index([module])
  @@map("permissions")
}

/// 角色权限映射
model RolePermission {
  id            String              @id @default(uuid())
  role          ExtendedAdminRole
  permissionId  String
  permission    Permission          @relation(fields: [permissionId], references: [id])
  
  orgId         String?             // null = 全局默认
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  
  @@unique([role, permissionId, orgId])
  @@index([role])
  @@index([orgId])
  @@map("role_permissions")
}
