// ============================================================================
// CTEA Platform - Prisma Schema (Part 1: System & Finance)
// ============================================================================
// Architecture: PostgreSQL 14+ with Prisma ORM
// Audit Event: M3.4-GLOBAL-COMP-002A
// Migration Date: 2026-01-12
// Source: Drizzle MySQL Schema (74 tables)
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum OrganizationLevel {
  HQ
  ORG
  STORE
}

enum OrganizationStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AdminUserRole {
  HQ_ADMIN
  HQ_OPERATOR
  ORG_ADMIN
  ORG_OPERATOR
  STORE_MANAGER
  STORE_STAFF
}

enum AdminUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_ACTIVATION
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
}

enum OperatorType {
  ADMIN
  USER
  SYSTEM
  API
}

enum ConfigValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
}

enum AccountType {
  DEPOSIT
  REVENUE
  SETTLEMENT
}

enum AccountStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum SettlementCycle {
  DAILY
  WEEKLY
  MONTHLY
}

enum SettlementStatus {
  PENDING
  PROCESSING
  SETTLED
  CANCELLED
}

enum BatchStatus {
  DRAFT
  CONFIRMED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// 第一章：系统管理模块 (System Management)
// ============================================================================

/// 组织表 - 三级架构：总部(HQ) → 组织(ORG) → 门店(STORE)
model Organization {
  id        String              @id @default(uuid())
  parentId  String?
  parent    Organization?       @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children  Organization[]      @relation("OrganizationHierarchy")
  
  code      String              @unique @db.VarChar(50)
  name      Json                // 多语言名称 {ru, zh, en}
  level     OrganizationLevel
  timezone  String              @default("Europe/Moscow") @db.VarChar(50)
  currency  String              @default("RUB") @db.VarChar(10)
  status    OrganizationStatus  @default(ACTIVE)
  config    Json?               // 组织级配置
  
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  createdBy String?
  updatedBy String?
  
  // Relations
  stores              Store[]
  adminUsers          AdminUser[]
  depositAccounts     DepositAccount[]
  settlementRules     SettlementRule[]
  crossStoreLedgers   CrossStoreLedger[]
  settlementBatches   SettlementBatch[]
  systemConfigs       SystemConfig[]
  auditLogs           AuditLog[]
  
  @@index([parentId])
  @@index([level])
  @@map("organizations")
}

/// 门店表
model Store {
  id              String              @id @default(uuid())
  orgId           String
  organization    Organization        @relation(fields: [orgId], references: [id])
  
  code            String              @db.VarChar(50)
  name            Json                // 多语言名称 {ru, zh, en}
  address         Json?               // 多语言地址 {ru, zh, en}
  phone           String?             @db.VarChar(20)
  email           String?             @db.VarChar(255)
  timezone        String              @default("Europe/Moscow") @db.VarChar(50)
  latitude        Decimal?            @db.Decimal(10, 7)
  longitude       Decimal?            @db.Decimal(10, 7)
  businessHours   Json?               // 营业时间配置
  cutoffHour      Int                 @default(5)
  iikoTerminalId  String?             @db.VarChar(100)
  status          OrganizationStatus  @default(ACTIVE)
  config          Json?               // 门店级配置
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       String?
  updatedBy       String?
  
  // Relations
  adminUsers            AdminUser[]
  depositAccounts       DepositAccount[]
  crossStoreLedgersIssue CrossStoreLedger[] @relation("IssueStore")
  crossStoreLedgersRedeem CrossStoreLedger[] @relation("RedeemStore")
  systemConfigs         SystemConfig[]
  
  @@unique([orgId, code])
  @@index([orgId])
  @@map("stores")
}

/// 管理员用户表
model AdminUser {
  id              String            @id @default(uuid())
  orgId           String?
  organization    Organization?     @relation(fields: [orgId], references: [id])
  storeId         String?
  store           Store?            @relation(fields: [storeId], references: [id])
  
  username        String            @unique @db.VarChar(50)
  passwordHash    String            @db.VarChar(255)
  phone           String?           @db.VarChar(20)
  phoneVerified   Boolean           @default(false)
  email           String?           @db.VarChar(255)
  name            Json?             // 多语言名称 {ru, zh, en}
  role            AdminUserRole
  permissions     Json?             // 权限列表
  languagePref    String            @default("ru") @db.VarChar(10)
  status          AdminUserStatus   @default(PENDING_ACTIVATION)
  lastLoginAt     DateTime?
  lastLoginIp     String?           @db.VarChar(45)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@index([orgId])
  @@index([storeId])
  @@index([role])
  @@map("admin_users")
}

/// 审计日志表 - Diff Log（不可篡改）+ SHA-256 链式审计
model AuditLog {
  id            BigInt          @id @default(autoincrement())
  orgId         String?
  organization  Organization?   @relation(fields: [orgId], references: [id])
  
  tableName     String          @db.VarChar(100)
  recordId      String          @db.VarChar(100)
  action        AuditAction
  diffBefore    Json?           // 修改前数据
  diffAfter     Json?           // 修改后数据
  operatorId    String?
  operatorType  OperatorType?
  operatorName  String?         @db.VarChar(100)
  ipAddress     String?         @db.VarChar(45)
  userAgent     String?
  reason        String?
  
  // SHA-256 链式审计字段（M3.4-GLOBAL-COMP-002 要求）
  eventId       String?         @unique @db.VarChar(100)
  previousHash  String?         @db.VarChar(64)
  sha256Hash    String?         @db.VarChar(64)
  
  createdAt     DateTime        @default(now())
  
  @@index([orgId])
  @@index([tableName])
  @@index([tableName, recordId])
  @@index([createdAt])
  @@index([eventId])
  @@map("audit_logs")
}

/// 系统配置表 - 参数化配置（严禁 Hardcode）
model SystemConfig {
  id            String          @id @default(uuid())
  orgId         String?
  organization  Organization?   @relation(fields: [orgId], references: [id])
  storeId       String?
  store         Store?          @relation(fields: [storeId], references: [id])
  
  configKey     String          @db.VarChar(100)
  configValue   Json
  valueType     ConfigValueType
  description   Json?           // 多语言描述 {ru, zh, en}
  isEditable    Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@unique([orgId, storeId, configKey])
  @@map("system_configs")
}

/// 权限规则表
model PermissionRule {
  id          String    @id @default(uuid())
  role        String    @db.VarChar(50)
  resource    String    @db.VarChar(100)
  action      String    @db.VarChar(50)
  conditions  Json?     // 条件表达式
  isAllowed   Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@index([role])
  @@index([resource])
  @@map("permission_rules")
}

// ============================================================================
// 第二章：财务模块 (Finance)
// ============================================================================

/// 虚拟保证金账户表
model DepositAccount {
  id            String          @id @default(uuid())
  orgId         String
  organization  Organization    @relation(fields: [orgId], references: [id])
  storeId       String
  store         Store           @relation(fields: [storeId], references: [id])
  
  accountType   AccountType     @default(DEPOSIT)
  balance       Decimal         @default(0.00) @db.Decimal(15, 2)
  frozenAmount  Decimal         @default(0.00) @db.Decimal(15, 2)
  currency      String          @default("RUB") @db.VarChar(10)
  status        AccountStatus   @default(ACTIVE)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@unique([storeId, accountType])
  @@index([orgId])
  @@map("deposit_accounts")
}

/// 结算规则表
model SettlementRule {
  id                    String            @id @default(uuid())
  orgId                 String?
  organization          Organization?     @relation(fields: [orgId], references: [id])
  
  ruleCode              String            @db.VarChar(50)
  name                  Json              // 多语言名称
  delayDays             Int               @default(7)
  autoRefundThreshold   Decimal           @default(0.30) @db.Decimal(5, 2)
  settlementCycle       SettlementCycle   @default(WEEKLY)
  isActive              Boolean           @default(true)
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  createdBy             String?
  updatedBy             String?
  
  @@map("settlement_rules")
}

/// 跨店对账表 - A店发券B店核销
model CrossStoreLedger {
  id                BigInt            @id @default(autoincrement())
  orgId             String
  organization      Organization      @relation(fields: [orgId], references: [id])
  orderId           BigInt
  couponId          String
  userCouponId      String
  issueStoreId      String
  issueStore        Store             @relation("IssueStore", fields: [issueStoreId], references: [id])
  redeemStoreId     String
  redeemStore       Store             @relation("RedeemStore", fields: [redeemStoreId], references: [id])
  
  amount            Decimal           @db.Decimal(15, 2)
  settlementStatus  SettlementStatus  @default(PENDING)
  settlementBatchId String?
  settlementBatch   SettlementBatch?  @relation(fields: [settlementBatchId], references: [id])
  settledAt         DateTime?
  businessDate      String?           @db.VarChar(10)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@index([orgId])
  @@index([orderId])
  @@index([issueStoreId])
  @@index([redeemStoreId])
  @@index([settlementStatus])
  @@map("cross_store_ledger")
}

/// 结算批次表
model SettlementBatch {
  id            String              @id @default(uuid())
  orgId         String
  organization  Organization        @relation(fields: [orgId], references: [id])
  
  batchNo       String              @unique @db.VarChar(50)
  periodStart   DateTime
  periodEnd     DateTime
  totalAmount   Decimal             @default(0.00) @db.Decimal(15, 2)
  netAmount     Decimal             @default(0.00) @db.Decimal(15, 2)
  recordCount   Int                 @default(0)
  status        BatchStatus         @default(DRAFT)
  confirmedBy   String?
  confirmedAt   DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String?
  updatedBy     String?
  
  // Relations
  crossStoreLedgers CrossStoreLedger[]
  
  @@map("settlement_batches")
}

/// 退款记录表
model RefundRecord {
  id              String        @id @default(uuid())
  orderId         String
  userId          String
  amount          Decimal       @db.Decimal(15, 2)
  reason          String?
  status          RefundStatus  @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  refundMethod    String?       @db.VarChar(50)
  refundReference String?       @db.VarChar(100)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("refund_records")
}

/// 财务报表表
model FinancialReport {
  id            String    @id @default(uuid())
  reportType    String    @db.VarChar(50)
  periodStart   DateTime
  periodEnd     DateTime
  reportData    Json      // 报表数据
  generatedBy   String?
  generatedAt   DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  
  @@index([reportType])
  @@index([periodStart, periodEnd])
  @@map("financial_reports")
}
